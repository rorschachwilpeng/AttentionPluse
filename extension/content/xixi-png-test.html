<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xixi PNG Widget - é˜¶æ®µ1 æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px;
      color: white;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 40px;
      font-size: 32px;
    }

    .test-section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .test-section h2 {
      margin-bottom: 20px;
      font-size: 24px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
    }

    .widget-container {
      width: 200px;
      height: 200px;
      margin: 20px auto;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      border: 2px dashed rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-top: 20px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    label {
      font-weight: 500;
      font-size: 14px;
    }

    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.2);
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      border: none;
    }

    .value-display {
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      margin-top: 10px;
    }

    .status-info {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 15px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
      line-height: 1.8;
      overflow-x: auto;
    }

    .status-info pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }

    button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    button.active {
      background: rgba(72, 187, 120, 0.5);
    }

    .test-result {
      margin-top: 15px;
      padding: 15px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.2);
    }

    .test-result.success {
      background: rgba(72, 187, 120, 0.2);
      border-left: 4px solid #48bb78;
    }

    .test-result.error {
      background: rgba(237, 137, 54, 0.2);
      border-left: 4px solid #ed8936;
    }

    .loading {
      text-align: center;
      padding: 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ™ Xixi PNG Widget - é˜¶æ®µ1 æµ‹è¯•</h1>

    <!-- æµ‹è¯•åŒºåŸŸ -->
    <div class="test-section">
      <h2>1. Widget æ˜¾ç¤ºåŒºåŸŸ</h2>
      <div class="widget-container" id="widget-container">
        <div class="loading">åŠ è½½ä¸­...</div>
      </div>
    </div>

    <!-- æ§åˆ¶åŒºåŸŸ -->
    <div class="test-section">
      <h2>2. D å€¼æ§åˆ¶</h2>
      <div class="controls">
        <div class="control-group">
          <label for="d-value">æ³¨æ„åŠ›æ‰°åŠ¨æŒ‡æ•° (D): <span id="d-display">0.40</span></label>
          <input type="range" id="d-value" min="0" max="1" step="0.01" value="0.4">
          <div class="value-display">
            çŠ¶æ€: <span id="status-text">ä¸­ç«‹</span>
          </div>
        </div>

        <div class="control-group">
          <label>å¿«é€Ÿæµ‹è¯•:</label>
          <div class="button-group">
            <button onclick="setDValue(0.0)" id="btn-calm">D = 0 (å†·é™)</button>
            <button onclick="setDValue(0.4)" id="btn-baseline" class="active">D = 0.4 (ä¸­ç«‹)</button>
            <button onclick="setDValue(0.7)" id="btn-restless">D = 0.7 (æµ®èº)</button>
            <button onclick="setDValue(1.0)" id="btn-max">D = 1.0 (æœ€å¤§)</button>
          </div>
        </div>
      </div>
    </div>

    <!-- çŠ¶æ€ä¿¡æ¯ -->
    <div class="test-section">
      <h2>3. çŠ¶æ€ä¿¡æ¯</h2>
      <div class="status-info" id="status-info">
        ç­‰å¾…åˆå§‹åŒ–...
      </div>
    </div>

    <!-- æµ‹è¯•ç»“æœ -->
    <div class="test-section">
      <h2>4. æµ‹è¯•ç»“æœ</h2>
      <div class="test-result" id="test-result">
        ç­‰å¾…æµ‹è¯•...
      </div>
      <div style="margin-top: 15px;">
        <button onclick="runTests()">è¿è¡Œæµ‹è¯•</button>
        <button onclick="updateStatus()">åˆ·æ–°çŠ¶æ€</button>
      </div>
    </div>
  </div>

  <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
  <script src="xixiImagePaths.js"></script>
  <script src="xixiStateManager.js"></script>
  <script src="xixiImageLoader.js"></script>
  <script src="xixiPNGWidget.js"></script>

  <script>
    // å…¨å±€å˜é‡
    let xixiWidget = null;
    let statusUpdateInterval = null;

    // åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('[Test] å¼€å§‹åˆå§‹åŒ–...');
      
      const container = document.getElementById('widget-container');
      const loadingDiv = container.querySelector('.loading');
      
      try {
        // åˆ›å»º Widget
        xixiWidget = new XixiPNGWidget(container, {
          sizeMin: 80,
          sizeMax: 180,
          opacityMin: 0.6,
          opacityMax: 1.0
        });

        // ç­‰å¾…åˆå§‹åŒ–å®Œæˆ
        await xixiWidget.init();
        
        // ç§»é™¤åŠ è½½æç¤º
        if (loadingDiv) {
          loadingDiv.remove();
        }

        // è®¾ç½®åˆå§‹ D å€¼
        xixiWidget.setTurbulence(0.4);
        updateStatus();
        
        // å¯åŠ¨çŠ¶æ€æ›´æ–°
        startStatusUpdate();
        
        // ç»‘å®šæ»‘å—
        const slider = document.getElementById('d-value');
        slider.addEventListener('input', (e) => {
          const value = parseFloat(e.target.value);
          setDValue(value);
        });

        // è¿è¡Œåˆå§‹æµ‹è¯•
        setTimeout(() => {
          runTests();
        }, 1000);

        console.log('[Test] åˆå§‹åŒ–å®Œæˆ');
      } catch (error) {
        console.error('[Test] åˆå§‹åŒ–å¤±è´¥:', error);
        if (loadingDiv) {
          loadingDiv.textContent = `åˆå§‹åŒ–å¤±è´¥: ${error.message}`;
          loadingDiv.style.color = '#ed8936';
        }
      }
    });

    // è®¾ç½® D å€¼
    function setDValue(value) {
      if (!xixiWidget) return;
      
      xixiWidget.setTurbulence(value);
      updateStatus();
      
      // æ›´æ–°æ˜¾ç¤º
      document.getElementById('d-display').textContent = value.toFixed(2);
      
      // æ›´æ–°çŠ¶æ€æ–‡æœ¬
      const statusText = document.getElementById('status-text');
      const stateInfo = xixiWidget.stateManager.getStateInfo(value);
      statusText.textContent = getStateName(stateInfo.state);
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.button-group button').forEach(btn => {
        btn.classList.remove('active');
      });
      if (value === 0.0) document.getElementById('btn-calm').classList.add('active');
      else if (value === 0.4) document.getElementById('btn-baseline').classList.add('active');
      else if (value === 0.7) document.getElementById('btn-restless').classList.add('active');
      else if (value === 1.0) document.getElementById('btn-max').classList.add('active');
    }

    // è·å–çŠ¶æ€åç§°ï¼ˆä¸­æ–‡ï¼‰
    function getStateName(state) {
      const names = {
        calm: 'å†·é™',
        baseline: 'ä¸­ç«‹',
        restless: 'æµ®èº'
      };
      return names[state] || state;
    }

    // æ›´æ–°çŠ¶æ€ä¿¡æ¯
    function updateStatus() {
      if (!xixiWidget) return;
      
      const status = xixiWidget.getStatus();
      const statusInfo = document.getElementById('status-info');
      
      statusInfo.innerHTML = `<pre>${JSON.stringify(status, null, 2)}</pre>`;
    }

    // å¯åŠ¨çŠ¶æ€æ›´æ–°
    function startStatusUpdate() {
      if (statusUpdateInterval) {
        clearInterval(statusUpdateInterval);
      }
      
      statusUpdateInterval = setInterval(() => {
        if (xixiWidget) {
          xixiWidget.update();
          updateStatus();
        }
      }, 100); // æ¯ 100ms æ›´æ–°ä¸€æ¬¡
    }

    // è¿è¡Œæµ‹è¯•
    function runTests() {
      const resultDiv = document.getElementById('test-result');
      const tests = [];
      
      // æµ‹è¯•1: æ£€æŸ¥åˆå§‹åŒ–
      tests.push({
        name: 'åˆå§‹åŒ–æ£€æŸ¥',
        test: () => xixiWidget && xixiWidget.isInitialized,
        message: 'Widget å·²åˆå§‹åŒ–'
      });
      
      // æµ‹è¯•2: æ£€æŸ¥å›¾ç‰‡åŠ è½½
      tests.push({
        name: 'å›¾ç‰‡åŠ è½½æ£€æŸ¥',
        test: () => {
          const loader = xixiWidget.imageLoader;
          return loader && loader.isAllLoaded();
        },
        message: 'æ‰€æœ‰å›¾ç‰‡å·²åŠ è½½'
      });
      
      // æµ‹è¯•3: æ£€æŸ¥çŠ¶æ€åˆ¤æ–­
      tests.push({
        name: 'çŠ¶æ€åˆ¤æ–­æ£€æŸ¥',
        test: () => {
          const stateManager = xixiWidget.stateManager;
          const state1 = stateManager.getState(0.2); // åº”è¯¥è¿”å› 'calm'
          const state2 = stateManager.getState(0.5); // åº”è¯¥è¿”å› 'baseline'
          const state3 = stateManager.getState(0.8); // åº”è¯¥è¿”å› 'restless'
          return state1 === 'calm' && state2 === 'baseline' && state3 === 'restless';
        },
        message: 'çŠ¶æ€åˆ¤æ–­æ­£ç¡®'
      });
      
      // æµ‹è¯•4: æ£€æŸ¥å›¾ç‰‡æ˜¾ç¤º
      tests.push({
        name: 'å›¾ç‰‡æ˜¾ç¤ºæ£€æŸ¥',
        test: () => {
          const img = xixiWidget.imgElement;
          return img && img.src && img.complete;
        },
        message: 'å›¾ç‰‡å·²æ˜¾ç¤º'
      });
      
      // è¿è¡Œæ‰€æœ‰æµ‹è¯•
      let passed = 0;
      let failed = 0;
      const results = [];
      
      tests.forEach(test => {
        try {
          const result = test.test();
          if (result) {
            passed++;
            results.push(`âœ… ${test.name}: ${test.message}`);
          } else {
            failed++;
            results.push(`âŒ ${test.name}: æµ‹è¯•å¤±è´¥`);
          }
        } catch (error) {
          failed++;
          results.push(`âŒ ${test.name}: ${error.message}`);
        }
      });
      
      // æ˜¾ç¤ºç»“æœ
      const allPassed = failed === 0;
      resultDiv.className = `test-result ${allPassed ? 'success' : 'error'}`;
      resultDiv.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 10px;">
          ${allPassed ? 'âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡' : `âš ï¸ ${failed} ä¸ªæµ‹è¯•å¤±è´¥`}
        </div>
        <div style="font-size: 12px; line-height: 1.8;">
          ${results.join('<br>')}
        </div>
        <div style="margin-top: 10px; font-size: 12px; color: rgba(255,255,255,0.7);">
          é€šè¿‡: ${passed} | å¤±è´¥: ${failed} | æ€»è®¡: ${tests.length}
        </div>
      `;
    }
  </script>
</body>
</html>

